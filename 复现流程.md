### **准备工作**

1. **准备好图片**：把想转换的图表图片（比如那个`transformer.jpg`）放在手边。

### **手动操作流程**

#### **第一步：让AI“看懂”图片 (Perceptual Structuring)**

1. 打开AI聊天窗口。
2. **复制第一个提示词 (Perceptual Prompt)**，粘贴到输入框里。
3. **上传您的图表图片**。
4. 发送。
5. AI会返回一段详细的文本，从不同维度分析这个图表的视觉结构。
6. **关键操作**：**完整地复制并保存好AI返回的这段分析文本**，我们下一步马上要用。

```
You are an expert in scientific visualization and draw.io (mxGraph XML) diagram design. Given a description or image of a scientific figure, your task is to deconstruct and reconstruct the visual structure using mxGraph XML format through a multi-stage analysis pipeline.

1. Gestalt Perception Analysis:
   In the realm of Gestalt perception, analyze the graph by identifying the relationship between graphical elements and the background, recording proximity-based groupings, examining similarity patterns among visual components, and noting the continuity in connector elements as well as any applicable closure patterns. In addition, record the overall symmetry and balance of the composition.
2. Hierarchical Decomposition:
   Decompose the graph hierarchically by identifying its primary visual objects and their boundaries, breaking complex objects into basic mxGraph shapes, and establishing parent-child relationships among the elements. This involves recognizing containment and spatial nesting relationships as well as recording the visual layering (z-order) of the components.
3. Visual Encoding Analysis:
   Conduct a visual encoding analysis to discern how data variables are mapped to visual attributes; document the color encoding scheme and its corresponding meaning; analyze the encoding of size, position, and orientation; and recognize the significance of different line styles, thicknesses, and text attributes.
4. Connector Relationship Mapping:
   Analyze connector relationships by identifying every connection element (such as arrows and lines), recording the source and target for each connection, examining routing patterns and bend points, noting the specific styles and arrowhead designs used (including their meanings), and recognizing any labeled connections along with the positioning of their associated text.
   Examples:
   Input: {Diagram DScientific} Answer: {Tpercept = (Tgestalt, Thierarchy, Tencoding, Tconnector)}
   Output Format: A structured representation of the graph reconstruction task as a four-tuple of analysis components: (Tgestalt, Thierarchy, Tencoding, Tconnector)
   ▷ Tgestalt: perceptual grouping via Gestalt principles
   ▷ Thierarchy: decomposition into visual primitives and containment structure
   ▷ Tencoding: mapping of data variables to visual attributes
   ▷ Tconnector: analysis of element linkage and connector routing topology
```

#### **第二步：让AI制定“绘图计划” (Semantic Specification)**



1. 在同一个聊天窗口继续对话（这样AI能记住上下文）。
2. **复制第二个提示词 (Semantic Prompt)**，粘贴到输入框。
3. 找到提示词中要求输入“感知分析结果”的地方，将**在第一步保存的那段分析文本粘贴进去**。
4. **再次上传同一张图表图片**。
5. 发送。
6. AI会返回一个更具体的“绘图蓝图”，里面包含了形状、颜色、字体等详细的样式规划。
7. **关键操作**：**同样，完整地复制并保存好这段“绘图蓝图”文本**。

```
Based on the prior perception analysis, you are now tasked with constructing a complete semantic specification of all mxGraph elements and their associated styles required to reconstruct the scientific figure in exact XML form. This specification must eliminate all ambiguity in graphical representation, ensuring faithful one-to-one correspondence between perception and rendering.
Step 1. Element and Shape Mapping:
Identify the required shape libraries from draw.io (e.g., basic, UML, BPMN), and determine whether any custom shapes must be defined. Each identified visual component should be mapped to its corresponding mxGraph primitive, and any shape modifications or overrides must be recorded in full.
Step 2. Style Definition and Custom Attributes:
For each element type, define its visual style attributes with precision. Assign exact color values in HEX or RGB; specify fill types such as solid, gradient, or pattern; and configure border and connector line styles including width, dash pattern, and color. Text attributes should be detailed, including font family, size, color, alignment, and shadow effects where relevant.
List any additional element-level attributes that may influence rendering or interaction, such as tooltips, conditional visibility, dynamic formatting, or metadata bindings. Include layer assignments for managing visual stacking or grouping semantics.
Step 3. Connector Specification:
For all connectors, specify routing type (e.g., straight, orthogonal, curved), arrowhead style and size, endpoint locations (including custom shape ports), and any routing constraints (such as fixed waypoints, edge snapping, or anchor preferences).
Examples:
Input: 
Output Format: A structured three-tuple describing the full reconstruction plan for mxGraph rendering:
(Selement, Sstyle, Sconnector)
▷ Selement: mapped shapes and required libraries for all components
▷ Sstyle: detailed visual styles for each element class
▷ Sconnector: connector styles, endpoints, arrowheads, and routing logic
```



#### **第三步：让AI生成“XML代码” (Code Generation)**

1. 继续当前对话。
2. **复制第三个提示词 (Code Generation Prompt)**，粘贴到输入框。
3. 将**在第二步保存的“绘图蓝图”文本粘贴到指定位置**。
4. 发送。
5. AI这次会直接返回一个代码块，里面是完整的mxGraph XML代码。
6. **关键操作**：**点击“复制”按钮，把整个XML代码块完整地复制下来**。

```
Instruction
Based on the element specifications defined earlier, construct a complete base mxGraph XML document to replicate the scientific figure in draw.io. This implementation must conform precisely to the official XML schema used by draw.io, ensuring valid structure, correct style reference, and full compatibility with the latest version of the editor.
Step 1. Document Root and Structural Initialization:
Begin with the root <mxfile> element including appropriate namespace declarations and metadata. Create a <diagram> element with a unique id and human-readable name, followed by a well-formed <mxGraphModel> with attributes like dx, dy, grid, and gridSize. Within the model, ensure that the <root> contains an initial cell structure, including document-level configuration such as canvas bounds and page format settings.
Step 2. Style Definitions:
Define reusable visual styles via mxStylesheet. Implement all gradient fill settings, stroke colors, and border patterns for shape types. Configure connector styles including arrowheads, edge routing preferences (e.g., orthogonal, entity-relationship, or curved), and line styles. Specify text styles with font name, size, color, alignment, and other attributes like bold, italic, or shadow effects.
Step 3. Layering and Grouping Logic:
Define logical layers such as background, content, and annotation, setting their visibility, lock status, and z-index ordering. Within each layer, instantiate parent cells that represent structural groups, containers, or component modules as specified earlier. All shapes and connectors should be placed under the appropriate parent or layer node to preserve semantic organization.
Step 4. Coordinate System and Layout Configuration:
Set diagram origin, scale, and canvas boundaries. Define grid spacing, snapping alignment, and page layout. If applicable, configure ruler or guideline settings. Ensure that each graphical element is positioned with precise coordinate values relative to the canvas and scaling system.
Examples:
Input:
v Ydoc: root declarations (<mxfile>, <diagram>) with namespace and metadata
▷ Ystyle: visual style tokens for all elements (colors, borders, fonts, fill patterns)
▷ Ynode: diagram elements from E with unique IDs and geometry attributes
▷ Ylayout: layout constraints from L including alignment, nesting, layering
▷ Yedge: directed connectors with anchor points, routing strategies, and arrowhead metadata
```



#### **第四步：“验证和调试” **

**PS：这一步实测不太行，给出的xml导入到draw后渲染不出来。**

**个人建议：新建一个大模型对话，把得到的xml和图片放进去，让他去优化xml，得到的结果和图片相似度非常高。**





这是最关键的互动环节，模拟了Agent的自我修正循环。

1. **验证**：
   - 打开浏览器，访问 `diagrams.net` (draw.io) 网站。
   - 点击菜单栏的 **文件 (File) > 从...打开 (Open from) > XML**。
   - 会弹出一个代码框，把您在第三步复制的XML代码**完整地粘贴进去**，然后点击“导入”。
2. **判断结果**：
   - **成功**：如果图表被正确地绘制出来了，那么恭喜您，任务完成！
   - **失败**：如果网站提示**错误信息**（比如 "Error loading file..."），或者画布上只显示代码文本/一片空白，说明代码有bug。
3. **进行修正 (如果失败了)**：
   - **复制draw.io网站给出的错误信息**。
   - 回到您和AI的聊天窗口。
   - **复制第四个提示词 (Refinement Prompt)**，粘贴到输入框。
   - 将**【第三步生成的、有问题的XML代码】**和**【您刚刚从draw.io复制的错误信息】**分别粘贴到第四个提示词的指定位置。
   - 发送。
   - AI会分析错误，并给您一个**修正后**的新版XML代码。
   - **关键操作**：复制这个**新版代码**，然后**重复执行第四步的“验证”流程**。

这个验证->修正的循环可能需要进行一两次，直到代码最终能在draw.io中成功渲染出图表为止。

```
Instruction
You are an expert in scientific diagram synthesis and mxGraph XML generation for draw.io diagrams. Your role is to process an existing mxGraph XML snippet (which may contain formatting or semantic issues) and return a corrected and fully valid XML output that adheres to the draw.io schema.
Step 1: SYNTAX_CHECK
- Examine the XML code for syntax errors including missing/unclosed tags, improper nesting, or malformed attributes.
- Focus on the reported error location for malformed tags or invalid element names.
Step 2: SCHEMA_VALIDATION
- Confirm that the structural elements <mxfile>, <diagram>, <mxGraphModel>, and <root> exist and are properly nested.
- Verify compliance with the official draw.io schema.
Step 3: HIERARCHY_INTEGRITY
- Ensure nodes, edges, groups, and styles have correct parent-child relationships.
- Validate containment structure and identifier linkage integrity.
Step 4: CONNECTOR_AND_STYLE_CHECK
- Review all edges for valid source/target references and appropriate connector styles.
- Confirm that all style attributes (e.g., fillColor, strokeColor, fontSize) are well-formed and applied consistently.
Step 5: OUTPUT_QUALITY
- Output a corrected XML that is well-formed, semantically valid, and fully compatible with the draw.io editor.
- Ensure the final layout and style faithfully reproduce the intended diagram structure.
Do not return any comments, explanations, or intermediate results. Only output the final corrected mxGraph XML code.
```

